name: Deploy static site to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Behält workflow_dispatch bei

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Datei-Kopieren (SCP-Action)
      # Die appleboy/scp-action verwendet das 'key' Secret direkt zur Authentifizierung
      # und benötigt keinen vorherigen 'Prepare SSH' Schritt.
      - name: Copy files via SCP to Temp Directory
        uses: appleboy/scp-action@v1
        with:
          # Verbindungsinformationen
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          # Authentifizierungsschlüssel (Privater Schlüssel)
          key: ${{ secrets.EC2_SSH_KEY }} 
          # Quelldateien vom Runner (das gesamte Repository)
          source: ./* # Zieldateien auf dem EC2-Host
          target: /home/${{ secrets.EC2_USER }}/temp
          strip_components: 0 # Behält die Ordnerstruktur

      # 2. Remote-Befehle ausführen (SSH-Action)
      # Auch die appleboy/ssh-action verwendet das 'key' Secret direkt
      - name: Execute remote SSH commands (Deployment)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. Inhalte kopieren (überschreibt alte Dateien)
            # Wichtig: * ist nötig, um den Inhalt von temp, nicht den Ordner temp selbst, zu kopieren
            sudo cp -r /home/${{ secrets.EC2_USER }}/temp/* /usr/site/ 
            
            # 2. Temporäres Verzeichnis löschen
            sudo rm -rf /home/${{ secrets.EC2_USER }}/temp
            
            # 3. Nginx Konfiguration testen und neu laden
            sudo nginx -t && sudo systemctl reload nginx